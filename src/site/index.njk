---
layout: layouts/base.njk
---
<h1 class="w-full text-center text-3xl border-b-4 border-red-600 border-dashed bg-blue-200">Uncommon Locals</h1>

<section>
{% for product in products %}
  <div class="bg-yellow-100">
    <h2 class="w-2/3 mx-4 text-lg font-semibold text-yellow-900">{{ product.name }}</h2>
    <p class="w-2/3 mx-4 text-yellow-900">{{ product.amount | priceFormatter(product.currency) }}</p>
    <p class="w-2/3 mx-4 text-sm my-4 text-yellow-800">{{ product.description }}</p>
    <div class="flex overflow-x-scroll">
      {% for image in product.images %}
        <img src="{{ image }}" alt="{{ product.name }} {{ loop.index }}" />
      {% endfor %}
    </div>
    <form action="/api/create-checkout" method="POST" class="text-yellow-900">
      <label for="quantity" class="text-sm">Quantity:
      <input type="number" min="1" max="5" id="quantity" name="quantity" value="1" class="text-lg">
      <input type="hidden" name="sku" value="{{ product.sku }}">

      <button class="p-3 bg-green-200 hover:bg-green-300 text-green-900 rounded-lg">Buy Now!</button>
    </form>
  </div>
{% endfor %}
</section>

<script src="https://js.stripe.com/v3/"></script>
<script type="text/javascript">
  console.log('Thinking about buying something? Glad to see you in the dev tools!')

  var stripe = Stripe('{{ environment.stripePublishableKey }}');

  // Get all the buttons on the page
  const buttons = document.querySelectorAll('button')
  // Loop over the buttons 
  const clickHandler = buttons.forEach(b => {
    b.addEventListener('click', async event => {
      event.preventDefault()
      const form = new FormData(event.target.form)
      const order = {
        sku: form.get('sku'),
        quantity: Number(form.get('quantity'))
      }

      // the create-checkout serverless function takes the order data
      // and returns a Stripe Checkout sessionId
      const response = await fetch('/api/create-checkout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(order)
      })
      .then(response => {
        console.log(response)
        return response.json()
      })
      stripe.redirectToCheckout({
      // Make the id field from the Checkout Session creation API response
      // available to this file, so you can provide it as argument here
      // instead of the {{CHECKOUT_SESSION_ID}} placeholder.
      sessionId: response
      }).then(function (result) {
        // If `redirectToCheckout` fails due to a browser or network
        // error, display the localized error message to your customer
        // using `result.error.message`.
      })
    })
  })
</script>
